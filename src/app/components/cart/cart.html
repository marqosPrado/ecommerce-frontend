<app-header></app-header>
<app-line-session></app-line-session>

<main style="width: 100%; height: 100%; padding: 4rem">
  <div style="width: 100%; display: flex; flex-direction: row; gap: 1rem">
    <div style="width: 75%; height: 50%">
      <p-stepper [value]="activeStep" class="basis-[50rem]" [linear]="true">
        <p-step-list>
          <p-step [value]="1">Carrinho</p-step>
          <p-step [value]="2">Endereços</p-step>
          <p-step [value]="3">Pagamento</p-step>
        </p-step-list>

        <p-step-panels>
          <p-step-panel [value]="1">
            <ng-template #content>
              <div style="display: flex; flex-direction: column; gap: 2rem">
                <div style="
                      width: 100%;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding-bottom: 1rem;
                      border-bottom: 2px solid var(--input-border);
                    ">
                  <div style="display: flex; gap: 1rem; align-items: center">
                    <div style="
                          background: var(--color-blue);
                          width: 48px;
                          height: 48px;
                          border-radius: 8px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        ">
                      <i style="font-size: 24px; color: white;" class="pi pi-shopping-bag"></i>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                      <h2 style="color: var(--color-text-primary); margin: 0; font-size: 1.5rem;">Produtos e
                        Serviços</h2>
                      <span style="color: var(--color-text-secondary); font-size: 0.875rem;">
              {{ cartItems.length }} {{ cartItems.length === 1 ? 'item' : 'itens' }} no carrinho
            </span>
                    </div>
                  </div>

                  @if (cartItems && cartItems.length > 0) {
                    <p-button
                      icon="pi pi-trash"
                      size="large"
                      label="Limpar carrinho"
                      severity="danger"
                      variant="outlined"
                      (onClick)="clearCart()"
                    />
                  }
                </div>

                @if (cartItems && cartItems.length > 0) {
                  @for (item of cartItems; track item.product.id; let i = $index) {
                    <div class="flex flex-col h-48">
                      <div style="
                            display: flex;
                            flex-direction: column;
                            gap: 2rem;
                            border: 1px solid var(--input-border);
                            padding: 1.5rem;
                            border-radius: 10px;
                            background-color: var(--color-surface-dark);
                            transition: border-color 0.2s;
                          ">
                        <div style="width: 100%; display: flex;">
                          <div style="width: 60%; max-width: 60%; display: flex; gap: 0.5rem; flex-direction: row;">
                            <img
                              src="{{item.product.images[0]}}"
                              style="width: 120px; height: 120px; object-fit: cover; cursor: pointer; border: 2px solid var(--input-border); border-radius: 5px; transition: border 0.2s;"
                            />

                            <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem">
                              <div style="display: flex; flex-direction: column; gap: 0.3rem">
                                <span style="color: var(--color-text-muted); font-size: 0.875rem;">Orient</span>
                                <span
                                  style="font-weight: bold; color: var(--color-text-primary);">{{ item.product.title }}</span>
                              </div>

                              <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <span style="font-size: 12px; color: var(--color-text-secondary);">
                                  Com desconto à vista:
                                  <strong style="color: var(--color-green);">R$ {{ item.product.price }}</strong>
                                </span>
                                <span style="font-size: 12px; color: var(--color-text-secondary);">
                                  Parcelado no cartão sem juros:
                                  <strong style="color: var(--color-text-primary);">R$ {{ item.product.price }}</strong>
                                </span>
                              </div>
                            </div>
                          </div>

                          <form
                            style="width: 20%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem;"
                            [formGroup]="getItemFormGroup(i)">
                            <span style="color: var(--color-text-secondary); font-weight: 500;">Quant.</span>
                            <p-select
                              [options]="quantityOptions"
                              optionLabel="name"
                              class="w-full md:w-56"
                              [virtualScroll]="true"
                              [virtualScrollItemSize]="7"
                              formControlName="quantity"
                              appendTo="body"
                            />
                            <p-button
                              icon="pi pi-trash"
                              size="small"
                              label="Remover"
                              severity="danger"
                              variant="outlined"
                              (onClick)="removerFromCart(item.product.id)"
                            />
                          </form>

                          <div
                            style="width: 20%; display: flex; flex-direction: column; justify-content: center; align-items: end">
                            <span style="color: var(--color-text-secondary); font-size: 0.875rem;">Preço à vista:</span>
                            <span style="font-size: 16px; font-weight: bold; color: var(--color-green);">
                              {{ item.product.price | currency:'BRL' }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  }
                } @else {
                  <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        padding: 4rem 2rem;
                        border: 2px dashed var(--input-border);
                        border-radius: 10px;
                        text-align: center;
                        gap: 1.5rem;
                        color: var(--color-text-secondary);
                        background-color: var(--color-surface-dark);
                      ">
                    <i class="pi pi-inbox" style="font-size: 4rem; color: var(--color-text-muted);"></i>
                    <h2 style="color: var(--color-text-primary); margin: 0;">Seu carrinho está vazio!</h2>
                    <p style="color: var(--color-text-secondary); margin: 0;">
                      Parece que você ainda não adicionou nenhum produto à sua sacola de compras.
                    </p>
                    <p-button
                      label="Continuar Comprando"
                      severity="contrast"
                      size="large"
                      icon="pi pi-arrow-left"
                    />
                  </div>
                }
              </div>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="2">
            <ng-template #content>
              <div style="display: flex; flex-direction: column; gap: 0.75rem">
                @if (!showAddressForm) {
                  <div class="flex flex-col h-48">
                    <div
                      style="background-color: var(--color-surface-dark); border: 1px solid var(--input-border); border-radius: 8px; padding: 1.5rem;">
                      <form style="display: flex; flex-direction: column; gap: 1rem; width: 100%;"
                            [formGroup]="addressFormGroup">
                        <span style="color: var(--color-text-primary);"><strong>Selecione seu endereço:</strong></span>

                        @for (addr of addresses; track addr.id) {
                          <div [style]="{
                                'display': 'flex',
                                'gap': '0.5rem',
                                'border': '2px solid',
                                'border-color': addressFormGroup.get('address')?.value === addr.id ? 'var(--color-blue)' : 'var(--input-border)',
                                'padding': '1.5rem',
                                'border-radius': '10px',
                                'background-color': addressFormGroup.get('address')?.value === addr.id ? 'var(--color-background)' : 'transparent',
                                'transition': 'all 0.2s',
                                'cursor': 'pointer'
                              }">
                            <p-radiobutton
                              name="address"
                              [inputId]="'address' + addr.id"
                              formControlName="address"
                              [value]="addr.id"
                            />
                            <label [for]="'address' + addr.id" class="ml-2"
                                   style="color: var(--color-text-primary); cursor: pointer;">
                              {{ addr.street }}, {{ addr.number }} - {{ addr.city }}, {{ addr.stateId }}
                            </label>
                          </div>
                        }
                      </form>
                    </div>
                  </div>
                } @else {
                  <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        padding: 4rem 2rem;
                        border: 2px dashed var(--input-border);
                        border-radius: 10px;
                        text-align: center;
                        gap: 1.5rem;
                        background-color: var(--color-surface-dark);
                      ">
                    <form style="display: flex; flex-direction: column; gap: 1rem; width: 100%"
                          [formGroup]="newAddressForm">
                      <div style="display: flex; flex-direction: row; width: 100%; gap: 8px">
                        <div [style]="{'width': '45%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-floatlabel variant="on" [style]="{'width': '100%'}">
                            <p-select
                              [options]="[
                                { name: 'Casa', value: 'CASA' },
                                { name: 'Apartamento', value: 'APARTAMENTO' },
                              ]"
                              optionLabel="name"
                              optionValue="value"
                              inputId="typeResidence"
                              formControlName="typeResidence"
                              [style]="{'width': '100%'}"
                              size="large"
                            />
                            <label for="typeResidence" style="color: var(--color-text-secondary);">Tipo de
                              residência*</label>
                          </p-floatlabel>
                          @if (newAddressForm.get('typeResidence')?.invalid && newAddressForm.get('typeResidence')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário informar o tipo de
                              residência.
                            </div>
                          }
                        </div>

                        <div [style]="{'width': '55%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-select
                            [options]="[
                              {name: 'Rua', value: 'RUA'},
                              {name: 'Avenida', value: 'AVENIDA'},
                              {name: 'Rodovia', value: 'RODOVIA'}
                            ]"
                            optionLabel="name"
                            placeholder="Tipo de Logradouro*"
                            size="large"
                            optionValue="value"
                            formControlName="typePlace"
                            aria-label="Selecione um tipo de logradouro"
                            aria-required="true"
                          />
                          @if (newAddressForm.get('typePlace')?.invalid && newAddressForm.get('typePlace')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário selecionar o tipo de
                              logradouro.
                            </div>
                          }
                        </div>
                      </div>

                      <div style="display: flex; flex-direction: column; width: 100%; gap: 8px">
                        <div [style]="{'width': '100%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-floatlabel variant="on" [style]="{'width': '100%'}">
                            <input
                              pInputText
                              style="width: 100%"
                              id="street"
                              formControlName="street"
                              pSize="large"
                            />
                            <label for="street" style="color: var(--color-text-secondary);">Logradouro*</label>
                          </p-floatlabel>
                          @if (newAddressForm.get('street')?.invalid && newAddressForm.get('street')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário informar o
                              logradouro.
                            </div>
                          }
                        </div>
                      </div>

                      <div style="display: flex; flex-direction: row; width: 100%; gap: 8px">
                        <div [style]="{'width': '60%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-floatlabel variant="on" [style]="{'width': '100%'}">
                            <input
                              pInputText
                              id="district"
                              formControlName="neighborhood"
                              pSize="large"
                              style="width: 100%"
                            />
                            <label for="district" style="color: var(--color-text-secondary);">Bairro*</label>
                          </p-floatlabel>
                          @if (newAddressForm.get('neighborhood')?.invalid && newAddressForm.get('neighborhood')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário informar o bairro.
                            </div>
                          }
                        </div>

                        <div [style]="{'width': '40%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-floatlabel variant="on" [style]="{'width': '100%'}">
                            <input
                              pInputText
                              id="number"
                              formControlName="number"
                              pSize="large"
                              style="width: 100%"
                            />
                            <label for="number" style="color: var(--color-text-secondary);">Número*</label>
                          </p-floatlabel>
                          @if (newAddressForm.get('number')?.invalid && newAddressForm.get('number')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário informar o número.
                            </div>
                          }
                        </div>
                      </div>

                      <div style="display: flex; flex-direction: row; width: 100%; gap: 8px">
                        <div [style]="{'width': '30%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-floatlabel variant="on" [style]="{'width': '100%'}">
                            <p-inputmask
                              mask="99999-999"
                              id="cep"
                              formControlName="cep"
                              size="large"
                              [style]="{'width': '100%'}"
                            ></p-inputmask>
                            <label for="cep" style="color: var(--color-text-secondary);">CEP*</label>
                          </p-floatlabel>
                          @if (newAddressForm.get('cep')?.invalid && newAddressForm.get('cep')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário informar o CEP.
                            </div>
                          }
                        </div>

                        <div [style]="{'width': '70%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-floatlabel variant="on" [style]="{'width': '100%'}">
                            <input
                              pInputText
                              id="city"
                              formControlName="city"
                              style="width: 100%"
                              pSize="large"
                            />
                            <label for="city" style="color: var(--color-text-secondary);">Cidade*</label>
                          </p-floatlabel>
                          @if (newAddressForm.get('city')?.invalid && newAddressForm.get('city')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário informar a cidade.
                            </div>
                          }
                        </div>
                      </div>

                      <div style="display: flex; flex-direction: row; width: 100%; gap: 8px">
                        <div [style]="{'width': '50%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-select
                            [options]="[
                              {name: 'São Paulo', value: 25},
                              {name: 'Rio de Janeiro', value: 19}
                            ]"
                            optionLabel="name"
                            optionValue="value"
                            placeholder="Estado*"
                            formControlName="stateId"
                            size="large"
                            aria-label="Selecione um estado"
                            aria-required="true"
                          />
                          @if (newAddressForm.get('stateId')?.invalid && newAddressForm.get('stateId')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário selecionar um
                              estado.
                            </div>
                          }
                        </div>

                        <div [style]="{'width': '50%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                          <p-floatlabel variant="on" [style]="{'width': '100%'}">
                            <input
                              pInputText
                              id="country"
                              formControlName="country"
                              style="width: 100%"
                              pSize="large"
                            />
                            <label for="country" style="color: var(--color-text-secondary);">País*</label>
                          </p-floatlabel>
                          @if (newAddressForm.get('country')?.invalid && newAddressForm.get('country')?.touched) {
                            <div style="color: var(--color-red); font-size: 0.875rem;">É necessário informar o país.
                            </div>
                          }
                        </div>
                      </div>

                      <p-floatlabel variant="on" [style]="{'width': '100%'}">
                        <textarea
                          pTextarea
                          id="notes"
                          formControlName="observations"
                          rows="5"
                          [autoResize]="false"
                          style="width: 100%; resize: none"
                        ></textarea>
                        <label for="notes" style="color: var(--color-text-secondary);">Observações (opcional)</label>
                      </p-floatlabel>

                      <div style="width: 100%; display: flex; justify-content: center; align-items: center">
                        <p-button
                          severity="primary"
                          size="large"
                          label="Cadastrar endereço"
                          [loading]="loading"
                          (click)="onSubmitNewAddress()"
                        />
                      </div>
                    </form>
                  </div>
                }

                @if (showAddressForm) {
                  <p-button
                    variant="outlined"
                    size="large"
                    (click)="handleAddressForm()"
                  >
                    Cancelar
                  </p-button>
                } @else {
                  <p-button
                    variant="outlined"
                    size="large"
                    (click)="handleAddressForm()"
                  >
                    <i class="pi pi-plus"></i>
                    Cadastrar novo endereço
                  </p-button>
                }
              </div>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="3">
            <ng-template #content>
              <div class="flex flex-col h-48" style="display: flex; flex-direction: column; gap: 0.75rem">

                <!-- ========== SEÇÃO DE CUPONS DE TROCA ========== -->
                <div style="background-color: var(--color-surface-dark); border: 1px solid var(--input-border); border-radius: 8px; padding: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="color: var(--color-text-primary);"><strong>Cupons de Troca Disponíveis</strong></span>
                    <span style="color: var(--color-text-secondary); font-size: 0.875rem;">
            {{ selectedExchangeVouchersArray.length }} {{ selectedExchangeVouchersArray.length === 1 ? 'cupom selecionado' : 'cupons selecionados' }}
          </span>
                  </div>

                  @if (loadingExchangeVouchers) {
                    <div style="display: flex; justify-content: center; padding: 2rem;">
                      <p-progress-spinner strokeWidth="6" fill="transparent" animationDuration=".5s" [style]="{ width: '40px', height: '40px' }" />
                    </div>
                  } @else if (exchangeVouchers.length === 0) {
                    <div style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">
                      <i class="pi pi-ticket" style="font-size: 2.5rem; color: var(--color-text-muted); margin-bottom: 1rem; display: block;"></i>
                      <p style="margin: 0;">Você não possui cupons de troca disponíveis no momento.</p>
                    </div>
                  } @else {
                    <div style="width: 100%; display: flex; flex-direction: column; gap: 1rem">
                      @for (voucher of exchangeVouchers; track voucher.id) {
                        <div [style]="{
                'display': 'flex',
                'flex-direction': 'column',
                'gap': '0.5rem',
                'padding': '1rem',
                'border': '2px solid',
                'border-color': isVoucherSelected(voucher.id) ? 'var(--color-green)' : 'var(--input-border)',
                'border-radius': '8px',
                'background-color': isVoucherSelected(voucher.id) ? 'rgba(34, 197, 94, 0.05)' : 'transparent',
                'transition': 'all 0.2s'
              }">
                          <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                              <p-checkbox
                                [value]="voucher.id"
                                (onChange)="onVoucherCheckboxChange(voucher.id, $event.checked)"
                                [binary]="true"
                                [ngModel]="isVoucherSelected(voucher.id)"
                                [ngModelOptions]="{standalone: true}">
                              </p-checkbox>

                              <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="
                        background: linear-gradient(135deg, var(--color-green-dark), var(--color-green));
                        width: 48px;
                        height: 48px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 1.25rem;
                      ">
                                  <i class="pi pi-ticket"></i>
                                </div>

                                <div style="display: flex; flex-direction: column; gap: 0.25rem">
                        <span style="font-weight: 600; color: var(--color-text-primary); font-family: 'Courier New', monospace; font-size: 1.1rem;">
                          {{ voucher.identifier }}
                        </span>
                                  <span style="color: var(--color-green); font-size: 1.25rem; font-weight: 700;">
                          {{ voucher.amount | currency:'BRL' }}
                        </span>
                                </div>
                              </div>
                            </div>

                            @if (isVoucherSelected(voucher.id)) {
                              <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 6px;">
                                <i class="pi pi-check-circle" style="color: var(--color-green); font-size: 1rem;"></i>
                                <span style="color: var(--color-green); font-weight: 600; font-size: 0.875rem;">Selecionado</span>
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>

                    <!-- Resumo dos cupons selecionados -->
                    @if (selectedExchangeVouchersArray.length > 0) {
                      <div style="margin-top: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.05); border: 1px solid var(--color-green); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <div>
                  <span style="font-weight: 600; display: block; color: var(--color-text-primary);">
                    Total em cupons de troca:
                  </span>
                            <span style="font-size: 0.875rem; color: var(--color-text-secondary);">
                    {{ selectedExchangeVouchersArray.length }} {{ selectedExchangeVouchersArray.length === 1 ? 'cupom' : 'cupons' }} selecionado(s)
                  </span>
                          </div>
                          <span style="font-size: 1.5rem; font-weight: 700; color: var(--color-green);">
                  {{ totalVouchersValue | currency:'BRL' }}
                </span>
                        </div>
                      </div>
                    }
                  }
                </div>

                <!-- ========== SEÇÃO DE CARTÕES DE CRÉDITO ========== -->
                <div style="background-color: var(--color-surface-dark); border: 1px solid var(--input-border); border-radius: 8px; padding: 1.5rem;">

                  @if (!showCreditCardForm) {
                    <form style="display: flex; flex-direction: column; width: 100%;" [formGroup]="paymentForm">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <span style="color: var(--color-text-primary);">
                <strong>Cartões de Crédito</strong>
                @if (requiresCreditCard) {
                  <span style="color: var(--color-red); font-size: 0.875rem; margin-left: 0.5rem;">*obrigatório</span>
                }
              </span>
                        <span style="color: var(--color-text-secondary); font-size: 0.875rem;">
                {{ selectedCardIdsArray.length }} {{ selectedCardIdsArray.length === 1 ? 'cartão selecionado' : 'cartões selecionados' }}
              </span>
                      </div>

                      <!-- Alerta quando cupons não cobrem o total -->
                      @if (requiresCreditCard && selectedCardIdsArray.length === 0) {
                        <div style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 1rem;
                background-color: rgba(251, 146, 60, 0.1);
                border: 1px solid var(--color-orange);
                border-radius: 6px;
              ">
                          <i class="pi pi-exclamation-triangle" style="color: var(--color-orange); font-size: 14px;"></i>
                          <span style="color: var(--color-orange); font-size: 0.875rem;">
                  Os cupons selecionados não cobrem o valor total. Adicione pelo menos um cartão de crédito.
                </span>
                        </div>
                      }

                      <!-- Informação quando cupons cobrem o total -->
                      @if (!requiresCreditCard) {
                        <div style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 1rem;
                background-color: rgba(34, 197, 94, 0.1);
                border: 1px solid var(--color-green);
                border-radius: 6px;
              ">
                          <i class="pi pi-check-circle" style="color: var(--color-green); font-size: 14px;"></i>
                          <span style="color: var(--color-green); font-size: 0.875rem;">
                  Os cupons selecionados cobrem o valor total da compra! Cartão de crédito é opcional.
                </span>
                        </div>
                      }

                      <div style="width: 100%; display: flex; flex-direction: column; gap: 1rem">
                        @for (creditCard of creditCards; track creditCard.id) {
                          <div [style]="{
                  'display': 'flex',
                  'flex-direction': 'column',
                  'gap': '0.5rem',
                  'padding': '1rem',
                  'border': '2px solid',
                  'border-color': isCardSelected(creditCard.id) ? 'var(--color-blue)' : 'var(--input-border)',
                  'border-radius': '8px',
                  'background-color': isCardSelected(creditCard.id) ? 'var(--color-background)' : 'transparent',
                  'transition': 'all 0.2s'
                }">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                              <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <p-checkbox
                                  [value]="creditCard.id"
                                  (onChange)="onCardCheckboxChange(creditCard.id, $event.checked)"
                                  [binary]="true"
                                  [ngModel]="isCardSelected(creditCard.id)"
                                  [ngModelOptions]="{standalone: true}">
                                </p-checkbox>

                                @if (creditCard.cardFlag === CreditCardTypes.ELO) {
                                  <img src="/assets/elo.png" width="40" height="40"/>
                                } @else if (creditCard.cardFlag === CreditCardTypes.MASTERCARD) {
                                  <img src="/assets/mastercard.svg" width="40" height="40" alt="mastercard"/>
                                } @else if (creditCard.cardFlag === CreditCardTypes.VISA) {
                                  <img src="/assets/visa.svg" width="40" height="40" alt="visa"/>
                                }

                                <div style="display: flex; flex-direction: column; gap: 0.25rem">
                                  <span style="font-weight: 600; color: var(--color-text-primary);">{{ creditCard.printedName }}</span>
                                  <span style="color: var(--color-text-secondary); font-size: 0.875rem;">{{ creditCard.number }}</span>
                                  @if (creditCard.isMain) {
                                    <span style="color: var(--color-yellow); font-size: 0.75rem; font-weight: 600;">
                            <i class="pi pi-star-fill" style="font-size: 0.625rem;"></i> Cartão Principal
                          </span>
                                  }
                                </div>
                              </div>
                            </div>

                            @if (isCardSelected(creditCard.id)) {
                              <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--input-border);">
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                  <div style="display: flex; flex-direction: column; gap: 0.25rem; width: 50%;">
                                    <label for="installments-{{creditCard.id}}" style="font-size: 0.875rem; font-weight: 500; color: var(--color-text-secondary);">
                                      Número de parcelas
                                    </label>
                                    <p-select
                                      id="installments-{{creditCard.id}}"
                                      [options]="[
                              {name: '1x sem juros', value: '1'},
                              {name: '2x sem juros', value: '2'},
                              {name: '3x sem juros', value: '3'},
                              {name: '4x sem juros', value: '4'},
                              {name: '5x sem juros', value: '5'},
                              {name: '6x sem juros', value: '6'}
                            ]"
                                      optionLabel="name"
                                      formControlName="installments"
                                      appendTo="body"
                                      [style]="{'width': '100%'}"
                                    />
                                  </div>

                                  @if (selectedCardIdsArray.length > 1 && requiresCreditCard) {
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; width: 50%;">
                                      <label style="font-size: 0.875rem; font-weight: 500; color: var(--color-text-secondary);">
                                        Valor a ser cobrado
                                      </label>
                                      <span style="font-size: 1.125rem; font-weight: 600; color: var(--color-green);">
                              {{ ((totalPrice$ | async)! - totalVouchersValue) / selectedCardIdsArray.length | currency:'BRL' }}
                            </span>
                                      <span style="font-size: 0.75rem; color: var(--color-text-muted);">
                              (Dividido igualmente)
                            </span>
                                    </div>
                                  }
                                </div>
                              </div>
                            }
                          </div>
                        }
                      </div>

                      @if (selectedCardIdsArray.length > 1 && requiresCreditCard) {
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--color-background); border: 1px solid var(--input-border); border-radius: 8px;">
                          <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                              <span style="font-weight: 600; display: block; color: var(--color-text-primary);">Valor após cupons:</span>
                              <span style="font-size: 0.875rem; color: var(--color-text-secondary);">
                      Será dividido em {{ selectedCardIdsArray.length }} cartões
                    </span>
                            </div>
                            <span style="font-size: 1.5rem; font-weight: 700; color: var(--color-green);">
                    {{ (totalPrice$ | async)! - totalVouchersValue | currency:'BRL' }}
                  </span>
                          </div>
                        </div>
                      }
                    </form>
                  } @else {
                    <div style="padding: 2rem; width: 100%; text-align: center;">
                      <p style="color: var(--color-text-secondary);">Formulário de cadastro de novo cartão aqui...</p>
                    </div>
                  }
                </div>

                <!-- Botões de ação -->
                @if (showCreditCardForm) {
                  <p-button variant="outlined" size="large" (click)="handleCreditCardForm()">
                    Cancelar
                  </p-button>
                } @else {
                  <p-button variant="outlined" size="large" (click)="handleCreditCardForm()">
                    <i class="pi pi-plus"></i>
                    Cadastrar novo cartão de crédito
                  </p-button>
                }
              </div>
            </ng-template>
          </p-step-panel>
        </p-step-panels>
      </p-stepper>
    </div>

    <div style="width: 25%; padding: 1rem; display: flex; flex-direction: column; gap: 1.5rem">
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <i class="pi pi-file" style="font-size: 22px; color: var(--color-text-primary);"></i>
        <h2 style="color: var(--color-text-primary); margin: 0;">Resumo</h2>
      </div>

      <div style="
            padding: 1rem;
            background-color: var(--color-surface-dark);
            border: 1px solid var(--input-border);
            border-radius: 8px;
          ">
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 14px; color: var(--color-text-secondary);">Subtotal</span>
            <span style="color: var(--color-text-primary); font-weight: 600;">
              {{ totalPrice$ | async | currency:'BRL' }}
            </span>
          </div>

          @if (voucherState.isApplied) {
            <div style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding-top: 0.75rem;
                  border-top: 1px dashed var(--input-border);
                ">
              <span style="font-size: 14px; color: var(--color-green);">
                <i class="pi pi-tag" style="font-size: 12px;"></i>
                Desconto ({{ voucherState.data.discount_percentage }}%)
              </span>
              <span style="color: var(--color-green); font-weight: 600;">
                - {{ ((totalPrice$ | async)! * parseFloat(voucherState.data.discount_percentage) / 100) | currency:'BRL' }}
              </span>
            </div>

            <div style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding-top: 0.75rem;
                  border-top: 1px dashed var(--input-border);
                ">
              <span style="font-size: 16px; color: var(--color-text-primary); font-weight: bold;">Total</span>
              <span style="color: var(--color-green); font-weight: bold; font-size: 18px;">
                {{ ((totalPrice$ | async)! * (1 - parseFloat(voucherState.data.discount_percentage) / 100)) | currency:'BRL' }}
              </span>
            </div>
          } @else {
            <div style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding-top: 0.75rem;
                  border-top: 1px dashed var(--input-border);
                ">
              <span style="font-size: 16px; color: var(--color-text-primary); font-weight: bold;">Total</span>
              <span style="color: var(--color-text-primary); font-weight: bold; font-size: 18px;">
                {{ totalPrice$ | async | currency:'BRL' }}
              </span>
            </div>
          }
        </div>
      </div>

      @if (activeStep === 3) {
        <div style="
              padding: 1rem;
              background-color: var(--color-surface-dark);
              border: 1px solid var(--input-border);
              border-radius: 8px;
            ">
          <form [formGroup]="voucherForm" style="display: flex; flex-direction: column; gap: 0.75rem;">
            <label style="font-size: 14px; color: var(--color-text-secondary); font-weight: 500;">
              <i class="pi pi-ticket" style="font-size: 12px;"></i>
              Cupom de desconto
            </label>

            @if (!voucherState.isApplied) {
              <div style="display: flex; gap: 0.5rem;">
                <input
                  pInputText
                  placeholder="Ex: ALAN50"
                  style="width: 80%; text-transform: uppercase;"
                  maxlength="6"
                  formControlName="code"
                  [disabled]="voucherState.isLoading"
                />
                <p-button
                  label="Aplicar"
                  [loading]="voucherState.isLoading"
                  [disabled]="voucherForm.invalid || voucherState.isLoading"
                  (onClick)="applyVoucher()"
                  size="large"
                />
              </div>

              @if (voucherState.error) {
                <div style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      padding: 0.75rem;
                      background-color: rgba(239, 68, 68, 0.1);
                      border: 1px solid var(--color-red);
                      border-radius: 6px;
                    ">
                  <i class="pi pi-exclamation-circle" style="color: var(--color-red); font-size: 14px;"></i>
                  <span style="color: var(--color-red); font-size: 0.875rem;">
                    {{ voucherState.error }}
                  </span>
                </div>
              }
            }

            @if (voucherState.isApplied) {
              <div style="
                    display: flex;
                    flex-direction: column;
                    gap: 0.75rem;
                    padding: 1rem;
                    background-color: rgba(34, 197, 94, 0.1);
                    border: 1px solid var(--color-green);
                    border-radius: 6px;
                  ">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    <span style="color: var(--color-green); font-weight: 600; font-size: 0.875rem;">
                      <i class="pi pi-check-circle" style="font-size: 12px;"></i>
                      Cupom aplicado
                    </span>
                    <span style="color: var(--color-text-primary); font-weight: bold; font-size: 1rem;">
                      {{ voucherState.data.code }}
                    </span>
                    <span style="color: var(--color-text-secondary); font-size: 0.75rem;">
                      {{ voucherState.data.discount_percentage }}% de desconto
                    </span>
                  </div>
                  <p-button
                    icon="pi pi-times"
                    [text]="true"
                    severity="danger"
                    size="small"
                    (onClick)="removeVoucher()"
                    styleClass="p-button-sm"
                  />
                </div>
              </div>
            }
          </form>
        </div>
      }

      <div style="width: 100%; display: flex; gap: 0.5rem; flex-direction: column; align-items: center">
        @if (!hasLogin) {
          <a routerLink="/login" pButton style="width: 100%;">
            <span pButtonLabel>Fazer login/Registrar-se</span>
          </a>
        } @else {
          <p-button
            [label]="activeStep === 3 ? 'Finalizar Compra' : 'Próximo'"
            [icon]="activeStep === 3 ? 'pi pi-check' : 'pi pi-arrow-right'"
            iconPos="right"
            size="large"
            [style]="{width: '100%'}"
            (onClick)="activeStep === 3 ? finalizePurchase() : nextStep()"
            [disabled]="primaryDisabled"
          />
        }

        <p-button
          label="Voltar"
          severity="secondary"
          icon="pi pi-arrow-left"
          size="large"
          [style]="{width: '100%'}"
          (onClick)="previousStep()"
          [disabled]="activeStep === 1"
        />
      </div>
    </div>
  </div>
  <app-modal
    [(visible)]="showDialog"
    [header]="dialogParams?.header || ''"
    [iconClass]="dialogParams?.iconClass || 'pi pi-info-circle'"
    [iconColor]="dialogParams?.iconColor || '#6366f1'"
    [title]="dialogParams?.title || ''"
    [message]="dialogParams?.message || ''"
    [buttons]="dialogParams?.buttons || []"
    (visibleChange)="onDialogClose()"
  />
</main>
