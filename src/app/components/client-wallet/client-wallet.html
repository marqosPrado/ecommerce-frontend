<app-header/>
<p-toast position="bottom-right"></p-toast>
<p-confirmDialog />

<main style="padding: 3rem 12rem 4rem 12rem">
  <div style="display: flex; flex-direction: column; margin-bottom: 4rem; gap: 8px;">
    <div style="display: flex; flex-direction: row; align-items: center; gap: 8px;">
      <i class="pi pi-wallet"></i>
      <h2>Minha carteira</h2>
    </div>
    @if (showCreditCardForm()) {
      <span>Cadastre abaixo o seu cartão de crédito</span>
    } @else {
      <span>Gerencie seus cartões de crédito ou adicione novos</span>
    }
  </div>

  @if (loading()) {
    <div style="display: flex; justify-content: center; align-items: center; padding: 4rem;">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
    </div>
  } @else {
    <div style="display: flex; flex-direction: column; gap: 2rem">
      @if (!showCreditCardForm()) {
        <div style="display: flex; flex-direction: row; justify-content: space-between">
          <h2>Cartões</h2>
          <p-button
            label="ADICIONAR CARTÃO DE CRÉDITO"
            icon="pi pi-plus"
            (click)="handleCreditCardForm()"
          />
        </div>
      }

      @if (showCreditCardForm()) {
        <div style="display: flex; flex-direction: column; gap: 1rem">
          <div style="display: flex; flex-direction: row; align-items: center; gap: 8px;">
            <i class="pi pi-plus-circle"></i>
            <h2 style="font-size: 18px">Adicionar novo cartão</h2>
          </div>

          <form style="display: flex; flex-direction: column; gap: 1rem" [formGroup]="creditCardForm">
            <div [style]="{'width': '100%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
              <p-floatlabel variant="on">
                <p-inputmask
                  mask="9999 9999 9999 9999"
                  id="number"
                  [style]="{width: '100%'}"
                  [unmask]="true"
                  size="large"
                  placeholder="0000 0000 0000 0000"
                  formControlName="number"
                  aria-required="true"
                ></p-inputmask>
                <label for="number">Número do cartão*</label>
              </p-floatlabel>
              @if (creditCardForm.get('number')?.invalid && creditCardForm.get('number')?.touched) {
                <div class="alert alert-danger">
                  @if (creditCardForm.get('number')?.hasError('required')) {
                    <div style="color: #a44b4c;font-size: 0.875rem;">É necessário informar o número do cartão.</div>
                  }
                </div>
              }
            </div>

            <div style="width: 100%; display: flex; gap: 1rem">
              <div [style]="{'width': '50%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                <p-floatlabel variant="on" [style]="{'width': '100%'}">
                  <input
                    pInputText
                    id="printedName"
                    style="width: 100%"
                    formControlName="printedName"
                    pSize="large"
                  />
                  <label for="printedName">Nome impresso no cartão*</label>
                </p-floatlabel>
                @if (creditCardForm.get('printedName')?.invalid && creditCardForm.get('printedName')?.touched) {
                  <div class="alert alert-danger">
                    @if (creditCardForm.get('printedName')?.hasError('required')) {
                      <div style="color: #a44b4c;font-size: 0.875rem;">É necessário informar o nome impresso no cartão.</div>
                    }
                  </div>
                }
              </div>

              <div [style]="{'width': '50%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                <p-floatlabel variant="on">
                  <p-select
                    [options]="[
                      { name: 'Visa', value: 'VISA' },
                      { name: 'Mastercard', value: 'MASTERCARD' },
                      { name: 'American Express', value: 'AMERICAN_EXPRESS' },
                      { name: 'Elo', value: 'ELO' },
                      { name: 'Hipercard', value: 'HIPERCARD' }
                    ]"
                    optionLabel="name"
                    inputId="cardFlag"
                    optionValue="value"
                    size="large"
                    style="width: 100%"
                    formControlName="cardFlag"
                    aria-required="true"
                  />
                  <label for="cardFlag">Bandeira do cartão*</label>
                </p-floatlabel>
                @if (creditCardForm.get('cardFlag')?.invalid && creditCardForm.get('cardFlag')?.touched) {
                  <div class="alert alert-danger">
                    @if (creditCardForm.get('cardFlag')?.hasError('required')) {
                      <div style="color: #a44b4c;font-size: 0.875rem;">É necessário selecionar a bandeira do cartão.</div>
                    }
                  </div>
                }
              </div>
            </div>

            <div style="display: flex; flex-direction: row; width: 100%; gap: 8px">
              <div [style]="{'width': '100%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                <p-floatlabel variant="on" [style]="{'width': '100%'}">
                  <p-inputmask
                    mask="999"
                    id="securityCode"
                    size="large"
                    formControlName="securityCode"
                    [style]="{'width': '100%'}"
                  ></p-inputmask>
                  <label for="securityCode">Código de verificação*</label>
                </p-floatlabel>
                @if (creditCardForm.get('securityCode')?.invalid && creditCardForm.get('securityCode')?.touched) {
                  <div class="alert alert-danger">
                    @if (creditCardForm.get('securityCode')?.hasError('required')) {
                      <div style="color: #a44b4c;font-size: 0.875rem;">É necessário informar o código de segurança.</div>
                    }
                  </div>
                }
              </div>
            </div>

            <h3 style="margin-top: 0.5rem">Dados pessoais</h3>

            <div style="display: flex; flex-direction: row; width: 100%; gap: 8px">
              <div [style]="{'width': '50%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                <p-floatlabel variant="on">
                  <p-inputmask
                    mask="999.999.999-99"
                    id="cpf"
                    [unmask]="true"
                    size="large"
                    formControlName="cpf"
                    [style]="{'width': '100%'}"
                    placeholder="000.000.000-00"
                    aria-required="true"
                  ></p-inputmask>
                  <label for="cpf">CPF*</label>
                </p-floatlabel>

                @if (creditCardForm.get('cpf')?.invalid && creditCardForm.get('cpf')?.touched) {
                  <div class="alert alert-danger">
                    @if (creditCardForm.get('cpf')?.hasError('required')) {
                      <div style="color: #a44b4c;font-size: 0.875rem;">É necessário informar o CPF.</div>
                    }
                  </div>
                }
              </div>

              <div [style]="{'width': '50%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                <p-date-picker
                  [showIcon]="true"
                  dateFormat="dd/mm/yy"
                  formControlName="birthDate"
                  placeholder="Data de nascimento*"
                  size="large"
                  aria-required="true"
                />
                @if (creditCardForm.get('birthDate')?.invalid && creditCardForm.get('birthDate')?.touched) {
                  <div class="alert alert-danger">
                    @if (creditCardForm.get('birthDate')?.hasError('required')) {
                      <div style="color: #a44b4c;font-size: 0.875rem;">É necessário informar a data de nascimento.</div>
                    }
                  </div>
                }
              </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 0.5rem">
              <h3>Identificação do cartão:</h3>
              <p>Para facilitar na hora de concluir sua próxima compra, dê um apelido para seu cartão</p>
            </div>

            <div style="display: flex; flex-direction: row; width: 100%; gap: 8px">
              <div [style]="{'width': '100%', 'display': 'flex', 'flex-direction': 'column', 'gap': '8px'}">
                <p-floatlabel variant="on">
                  <input
                    pInputText
                    id="cardSurname"
                    pSize="large"
                    [style]="{'width': '100%'}"
                    name="cardSurname"
                    formControlName="surname"
                    maxlength="20"
                    aria-required="true"
                  />
                  <label for="cardSurname">Apelido para este cartão*</label>
                </p-floatlabel>
                @if (creditCardForm.get('surname')?.invalid && creditCardForm.get('surname')?.touched) {
                  <div class="alert alert-danger">
                    @if (creditCardForm.get('surname')?.hasError('required')) {
                      <div style="color: #a44b4c;font-size: 0.875rem;">É necessário informar um apelido para o cartão.</div>
                    }
                  </div>
                }
              </div>
            </div>

            <div class="flex items-center">
              <p-checkbox
                inputId="mainCard"
                formControlName="isMain"
                [binary]="true">
              </p-checkbox>
              <label for="mainCard" class="ml-2"> Este é meu cartão principal </label>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 2rem">
              <p-button
                label="Voltar para minha conta"
                variant="outlined"
                (onClick)="handleCreditCardForm()"
                [disabled]="loading()"
              />
              <p-button
                label="Cadastrar novo cartão"
                [disabled]="creditCardForm.invalid || loading()"
                [loading]="loading()"
                (onClick)="submitCreditCard()"
              />
            </div>
          </form>
        </div>
      } @else {
        @if (creditCards().length === 0) {
          <div style="text-align: center; padding: 4rem; color: #666;">
            <i class="pi pi-credit-card" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>Você ainda não possui cartões cadastrados.</p>
          </div>
        } @else {
          <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
            <p-card
              *ngFor="let card of creditCards(); let i = index"
              [header]="card.surname || 'CARTÃO ' + (i + 1)"
              [style]="{ width: '25%', height: 'auto'}"
            >
              <p class="m-0 mb-2">
                {{ card.number | maskCard }}
              </p>
              <p class="m-0 mb-2">
                {{ card.cardFlag }}
              </p>
              <p class="m-0 mb-2" *ngIf="card.isMain">
                <strong>(Cartão principal)</strong>
              </p>

              <ng-template #footer>
                <div class="flex gap-4 mt-1">
                  <p-button
                    label="Remover"
                    severity="secondary"
                    class="w-full"
                    [outlined]="true"
                    styleClass="w-full"
                    [disabled]="loading()"
                    (onClick)="removeCreditCard(card)"
                  />
                </div>
              </ng-template>
            </p-card>
          </div>
        }
      }
    </div>
  }
</main>
