<app-header></app-header>
<app-line-session></app-line-session>

<main style="
  width: 100%;
  min-height: 100vh;
  background: var(--color-surface-darker);
  padding: 4rem 2rem;
  box-sizing: border-box;
">
  <div style="
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  ">
    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <p-button
          icon="pi pi-arrow-left"
          [style]="{
            background: 'transparent',
            border: '1px solid var(--input-border)',
            color: 'var(--color-text-primary)'
          }"
          (onClick)="goBack()"
        ></p-button>

        <div>
          <h1 style="
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin: 0;
          ">
            Meus Pedidos
          </h1>
          <p style="
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            margin: 0.5rem 0 0 0;
          ">
            Acompanhe o histórico das suas compras
          </p>
        </div>
      </div>
    </div>

    <!-- Loading -->
    @if (loading) {
      <div style="
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 3rem;
      ">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: var(--color-blue);"></i>
      </div>
    }

    <!-- Lista de Pedidos -->
    @if (!loading && orders && orders.length > 0) {
      <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        @for (order of orders; track order.id) {
          <article
            style="
              background: var(--color-background);
              border: 1px solid var(--input-border);
              border-radius: 12px;
              padding: 1.5rem;
              transition: all 0.3s ease;
              cursor: pointer;
            "
            (click)="openDetails(order)"
          >
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 2rem;">
              <!-- Informações do Pedido -->
              <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                  <span style="
                    font-weight: 700;
                    font-size: 1.1rem;
                    color: var(--color-text-primary);
                  ">
                    {{ order.order_number }}
                  </span>

                  <p-tag
                    [value]="order.order_status.displayName"
                    [severity]="getStatusSeverity(order.order_status.code)"
                  ></p-tag>
                </div>

                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="pi pi-calendar" style="color: var(--color-text-secondary); font-size: 0.875rem;"></i>
                    <span style="color: var(--color-text-secondary); font-size: 0.95rem;">
                      {{ formatDate(order.created_at) }}
                    </span>
                  </div>

                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="pi pi-shopping-bag" style="color: var(--color-text-secondary); font-size: 0.875rem;"></i>
                    <span style="color: var(--color-text-secondary); font-size: 0.95rem;">
                      {{ getTotalItems(order) }} {{ getTotalItems(order) === 1 ? 'item' : 'itens' }}
                    </span>
                  </div>
                </div>

                <!-- Preview dos produtos -->
                <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem;">
                  @for (item of order.items.slice(0, 3); track item.id) {
                    <img
                      [src]="item.product.main_image"
                      [alt]="item.product.title"
                      style="
                        width: 60px;
                        height: 60px;
                        object-fit: cover;
                        border-radius: 8px;
                        border: 1px solid var(--input-border);
                      "
                    />
                  }
                  @if (order.items.length > 3) {
                    <div style="
                      width: 60px;
                      height: 60px;
                      border-radius: 8px;
                      background: var(--color-surface-dark);
                      border: 1px solid var(--input-border);
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 0.875rem;
                      color: var(--color-text-secondary);
                      font-weight: 600;
                    ">
                      +{{ order.items.length - 3 }}
                    </div>
                  }
                </div>
              </div>

              <!-- Valor Total -->
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                <span style="
                  color: var(--color-text-secondary);
                  font-size: 0.875rem;
                ">
                  Total
                </span>
                <span style="
                  font-size: 1.5rem;
                  font-weight: 700;
                  color: var(--color-blue);
                ">
                  {{ formatCurrency(order.pricing.total) }}
                </span>

                <p-button
                  label="Ver detalhes"
                  icon="pi pi-arrow-right"
                  iconPos="right"
                  size="small"
                  [style]="{
                    background: 'transparent',
                    border: '1px solid var(--input-border)',
                    color: 'var(--color-text-primary)',
                    marginTop: '0.5rem'
                  }"
                  (onClick)="openDetails(order); $event.stopPropagation()"
                ></p-button>
              </div>
            </div>
          </article>
        }
      </div>

      <!-- Controles de Paginação -->
      @if (totalPages > 1) {
        <div style="
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 1rem;
          margin-top: 2rem;
        ">
          <p-button
            icon="pi pi-chevron-left"
            [disabled]="currentPage === 0 || loading"
            [style]="{
              background: 'transparent',
              border: '1px solid var(--input-border)',
              color: 'var(--color-text-primary)'
            }"
            (onClick)="loadPreviousPage()"
          ></p-button>

          <span style="color: var(--color-text-secondary);">
            Página {{ currentPage + 1 }} de {{ totalPages }}
          </span>

          <p-button
            icon="pi pi-chevron-right"
            [disabled]="currentPage >= totalPages - 1 || loading"
            [style]="{
              background: 'transparent',
              border: '1px solid var(--input-border)',
              color: 'var(--color-text-primary)'
            }"
            (onClick)="loadNextPage()"
          ></p-button>
        </div>
      }
    }

    <!-- Estado Vazio -->
    @if (!loading && (!orders || orders.length === 0)) {
      <div style="
        background: var(--color-background);
        border: 2px dashed var(--input-border);
        border-radius: 12px;
        padding: 4rem 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 1.5rem;
      ">
        <i class="pi pi-inbox" style="font-size: 4rem; color: var(--color-text-muted);"></i>
        <div>
          <h2 style="
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin: 0 0 0.5rem 0;
          ">
            Nenhum pedido encontrado
          </h2>
          <p style="
            color: var(--color-text-secondary);
            margin: 0;
          ">
            Você ainda não realizou nenhuma compra
          </p>
        </div>
        <p-button
          label="Começar a comprar"
          icon="pi pi-shopping-cart"
          [style]="{
            background: 'var(--color-blue)',
            border: 'none',
            padding: '0.75rem 1.5rem'
          }"
        ></p-button>
      </div>
    }
  </div>
</main>

<!-- Modal de Detalhes -->
<p-dialog
  [(visible)]="showDetailsDialog"
  [modal]="true"
  [closable]="true"
  [style]="{width: '800px', maxWidth: '90vw'}"
  [contentStyle]="{background: 'var(--color-background)', padding: '0'}"
  [header]="'Detalhes do Pedido'"
>
  @if (selectedOrder) {
    <div style="display: flex; flex-direction: column; gap: 2rem; padding: 1.5rem;">
      <!-- Header do Pedido -->
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <span style="
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--color-text-primary);
          ">
            {{ selectedOrder.order_number }}
          </span>
          <span style="color: var(--color-text-secondary); font-size: 0.95rem;">
            {{ formatDate(selectedOrder.created_at) }}
          </span>
        </div>

        <p-tag
          [value]="selectedOrder.order_status.displayName"
          [severity]="getStatusSeverity(selectedOrder.order_status.code)"
          [style]="{fontSize: '1rem', padding: '0.5rem 1rem'}"
        ></p-tag>
      </div>

      <p-divider></p-divider>

      <!-- Produtos -->
      <div>
        <h3 style="
          font-size: 1.1rem;
          font-weight: 600;
          color: var(--color-text-primary);
          margin: 0 0 1rem 0;
        ">
          Produtos
        </h3>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
          @for (item of selectedOrder.items; track item.id) {
            <div style="
              display: flex;
              gap: 1rem;
              padding: 1rem;
              background: var(--color-surface-dark);
              border-radius: 8px;
            ">
              <img
                [src]="item.product.main_image"
                [alt]="item.product.title"
                style="
                  width: 80px;
                  height: 80px;
                  object-fit: cover;
                  border-radius: 8px;
                "
              />

              <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 0.25rem;">
                <span style="
                  font-weight: 600;
                  color: var(--color-text-primary);
                ">
                  {{ item.product.title }}
                </span>
                <span style="
                  color: var(--color-text-secondary);
                  font-size: 0.9rem;
                ">
                  {{ item.product.brand }}
                </span>
                <span style="
                  color: var(--color-text-secondary);
                  font-size: 0.9rem;
                ">
                  Quantidade: {{ item.quantity }}
                </span>
              </div>

              <div style="display: flex; align-items: center;">
                <span style="
                  font-weight: 700;
                  font-size: 1.1rem;
                  color: var(--color-blue);
                ">
                  {{ formatCurrency(item.subtotal) }}
                </span>
              </div>
            </div>
          }
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Endereço de Entrega -->
      <div>
        <h3 style="
          font-size: 1.1rem;
          font-weight: 600;
          color: var(--color-text-primary);
          margin: 0 0 1rem 0;
        ">
          Endereço de Entrega
        </h3>

        <div style="
          padding: 1rem;
          background: var(--color-surface-dark);
          border-radius: 8px;
          color: var(--color-text-secondary);
        ">
          <p style="margin: 0; line-height: 1.6;">
            {{ selectedOrder.shipping_address.type_place }} {{ selectedOrder.shipping_address.street }}
            , {{ selectedOrder.shipping_address.number }}<br>
            {{ selectedOrder.shipping_address.neighborhood }} - {{ selectedOrder.shipping_address.city }}
            /{{ selectedOrder.shipping_address.state }}<br>
            CEP: {{ selectedOrder.shipping_address.cep }}
            @if (selectedOrder.shipping_address.observations) {
              <br><br>
              <strong>Observações:</strong> {{ selectedOrder.shipping_address.observations }}
            }
          </p>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Pagamento -->
      <div>
        <h3 style="
          font-size: 1.1rem;
          font-weight: 600;
          color: var(--color-text-primary);
          margin: 0 0 1rem 0;
        ">
          Pagamento
        </h3>

        <div style="
          padding: 1rem;
          background: var(--color-surface-dark);
          border-radius: 8px;
          display: flex;
          flex-direction: column;
          gap: 1rem;
        ">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--color-text-secondary);">Subtotal</span>
            <span style="color: var(--color-text-primary); font-weight: 600;">
              {{ formatCurrency(selectedOrder.pricing.subtotal) }}
            </span>
          </div>

          @if (selectedOrder.payment.voucher) {
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--color-text-secondary);">
                Desconto ({{ selectedOrder.payment.voucher.code }})
              </span>
              <span style="color: var(--color-green); font-weight: 600;">
                - {{ formatCurrency(selectedOrder.pricing.discount) }}
              </span>
            </div>
          }

          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--color-text-secondary);">Taxa de entrega</span>
            <span style="color: var(--color-text-primary); font-weight: 600;">
              {{ formatCurrency(selectedOrder.pricing.delivery_fee) }}
            </span>
          </div>

          <p-divider></p-divider>

          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 0.25rem;">
                {{ selectedOrder.payment.credit_card.card_flag }} •••• {{ selectedOrder.payment.credit_card.last_digits }}
              </div>
              <div style="color: var(--color-text-secondary); font-size: 0.875rem;">
                {{ selectedOrder.payment.credit_card.printed_name }}
              </div>
            </div>

            <div style="text-align: right;">
              <div style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 0.25rem;">
                Total
              </div>
              <div style="
                font-weight: 700;
                font-size: 1.5rem;
                color: var(--color-blue);
              ">
                {{ formatCurrency(selectedOrder.pricing.total) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <ng-template #footer>
    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; padding: 1rem 1.5rem;">
      <p-button
        label="Fechar"
        icon="pi pi-times"
        [style]="{
          background: 'transparent',
          border: '1px solid var(--input-border)',
          color: 'var(--color-text-primary)'
        }"
        (onClick)="closeDetails()"
      />
    </div>
  </ng-template>
</p-dialog>
